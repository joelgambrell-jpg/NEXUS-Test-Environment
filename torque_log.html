<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="nexus-core.css" />
<link rel="stylesheet" href="nexus-core.print.css" media="print" />
<title>Torque Application Log</title>

<style>
  :root{
    --panel:rgba(255,255,255,0.20);
    --line:rgba(255,255,255,0.20);
    --btn-txt:#3ecbff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;font-family:Arial, Helvetica, sans-serif;color:#fff}
  body{
    min-height:100vh;
    background:
      radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,0.12), transparent 60%),
      radial-gradient(900px 600px at 80% 30%, rgba(0,194,255,0.12), transparent 55%),
      linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.65)),
      url("transformer.jpg");
    background-size:cover;
    background-attachment:fixed;
  }

  .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 30px}
  .top{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:12px 12px;border-radius:18px;
    background:rgba(0,0,0,0.28);
    border:1px solid rgba(255,255,255,0.18);
    backdrop-filter: blur(8px);
  }
  .top .left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .top .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
  .pillTop{
    display:inline-flex;align-items:center;justify-content:center;
    padding:7px 12px;border-radius:999px;
    border:1px solid rgba(255,255,255,0.18);
    background:rgba(0,0,0,0.18);
    font-weight:900;font-size:12px;color:rgba(255,255,255,0.92);
    letter-spacing:.02em;
    white-space:nowrap;
  }
  .btn{
    display:inline-flex;align-items:center;justify-content:center;
    padding:11px 16px;border-radius:14px;
    border:1px solid rgba(255,255,255,0.18);
    background:rgba(10,15,36,0.90);
    color:var(--btn-txt);
    font-weight:900;letter-spacing:.02em;
    cursor:pointer;text-decoration:none;
    box-shadow:0 10px 26px rgba(0,0,0,0.25);
    user-select:none;
  }
  .btn.secondary{background:rgba(0,0,0,0.25);color:rgba(255,255,255,0.92)}
  .btn:disabled{opacity:.55;cursor:not-allowed}

  .card{
    margin-top:14px;
    border-radius:22px;
    border:1px solid rgba(255,255,255,0.18);
    background:rgba(0,0,0,0.26);
    backdrop-filter: blur(10px);
    box-shadow:0 18px 45px rgba(0,0,0,0.35);
    overflow:hidden;
  }
  .cardHeader{
    padding:18px 18px 10px;
    border-bottom:1px solid rgba(255,255,255,0.16);
    background:rgba(0,0,0,0.22);
  }
  .title{margin:0;font-size:34px;font-weight:900;color:rgba(255,255,255,0.96)}
  .subtitle{margin-top:4px;font-size:14px;font-weight:800;color:rgba(255,255,255,0.82)}
  .actions{
    padding:14px 18px 0;
    display:flex;gap:12px;flex-wrap:wrap
  }
  .hint{padding:10px 18px 0;color:rgba(255,255,255,0.75);font-weight:800;font-size:12px}

  .content{padding:14px 18px 18px}
  .section{
    margin-top:14px;
    padding:14px 14px 14px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.16);
    background:rgba(255,255,255,0.10);
  }
  .section-title{
    font-weight:900;
    letter-spacing:.12em;
    text-transform:uppercase;
    font-size:13px;
    opacity:.95;
    margin:0 0 10px;
  }

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:860px){.grid2{grid-template-columns:1fr}}
  label{display:block;font-size:12px;font-weight:900;opacity:.92;margin-bottom:6px;letter-spacing:.02em}
  select,input,textarea{
    width:100%;
    padding:11px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.18);
    background:rgba(255,255,255,0.92);
    color:#111;
    font-weight:800;
    outline:none;
  }

  .row-actions{display:flex;gap:8px;justify-content:flex-end}
  .mini{padding:9px 12px;font-size:13px}

  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.12em;
    color:rgba(255,255,255,0.78);
    text-align:left;
    padding:0 10px 6px;
  }
  td{padding:0 6px}
  .cell{
    background:rgba(255,255,255,0.92);
    border:1px solid rgba(0,0,0,0.10);
    border-radius:14px;
    padding:8px 10px;
    color:#111;
    font-weight:800;
  }
  .cell input,.cell select,.cell textarea{
    border:none;background:transparent;padding:0;border-radius:0;
    font-weight:800;
  }

  /* Tilt go/no-go */
  .go-wrap{display:flex;gap:10px;align-items:center}
  .pill{flex:1;display:inline-flex;align-items:center;justify-content:center;height:38px;border-radius:999px;font-weight:900;border:2px solid rgba(255,255,255,0.25);cursor:pointer;user-select:none;transition:.12s}
  .pill.go{background:rgba(0,255,102,0.18);border-color:rgba(0,255,102,0.55);color:#eafff1}
  .pill.nogo{background:rgba(255,59,59,0.18);border-color:rgba(255,59,59,0.55);color:#ffecec}
  .pill.on{transform:translateY(-1px);box-shadow:0 10px 22px rgba(0,0,0,0.30)}
  .pill.go.on{background:rgba(0,255,102,0.35)}
  .pill.nogo.on{background:rgba(255,59,59,0.35)}

  /* Torque lock wrapper */
  .nx-torque-lock-wrap{ position:relative; }
  .nx-torque-lock-wrap.nx-locked{ filter: grayscale(1) opacity(0.55); pointer-events:none; }
  #nxTorqueLockOverlay{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
    border-radius:18px;
    background:rgba(0,0,0,0.45);
    backdrop-filter: blur(4px);
    z-index:50;
  }
  #nxTorqueLockOverlay .card2{
    width:min(740px,100%);
    text-align:center;
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.20);
    background:rgba(20,20,20,0.55);
    padding:16px;
    box-shadow:0 18px 50px rgba(0,0,0,0.55);
  }

  /* Torque photo display */
  .photoPreview{
    width:100%;
    max-height:280px;
    object-fit:contain;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.20);
    background:rgba(0,0,0,0.20);
    display:none;
    margin-top:10px;
  }
  .photoNote{margin-top:8px;color:rgba(255,255,255,0.80);font-weight:800;font-size:12px}

  @media (max-width:760px){.top{flex-direction:column;align-items:stretch}}
</style>
</head>
<body>

<div class="wrap">
  <div class="top">
    <div class="left">
      <a class="btn secondary" id="backBtn" href="equipment.html">Back</a>
      <span class="pillTop" id="eqLabel">Equipment: (none)</span>
      <span class="pillTop">Role: <span id="roleLabel">viewer</span></span>
      <span class="pillTop" id="readyPill">Ready</span>
    </div>
    <div class="right">
      <span class="pillTop">Set Role</span>
      <select id="nxRoleSelect" style="width:auto;min-width:160px">
        <option value="viewer">viewer</option>
        <option value="tech">tech</option>
        <option value="foreman">foreman</option>
        <option value="superintendent">superintendent</option>
        <option value="admin">admin</option>
      </select>
    </div>
  </div>

  <div class="card">
    <div class="cardHeader">
      <h1 class="title">Torque Application Log</h1>
      <div class="subtitle" id="subEq">Equipment: (none)</div>
    </div>

    <div class="actions">
      <a class="btn secondary" id="backBtn2" href="equipment.html">Back to Equipment</a>
      <button class="btn secondary" type="button" id="saveBtn">Save</button>
      <button class="btn secondary" type="button" id="exportEmailBtn">Export to Email</button>
    </div>

    <div class="hint">
      Fill out Tilt Test (Go/No Go) below to unlock torque entry.
    </div>

    <div class="content">

      <!-- Torque Photo DISPLAY (upload happens on index.html now) -->
      <div class="section" id="torquePhotoSection">
        <div class="section-title">Torque Photo</div>
        <div class="hint" style="padding:0;color:rgba(255,255,255,0.75);font-weight:800">
          Torque photo is uploaded on the Open Equipment page for this equipment and displayed here.
        </div>
        <img id="torquePhotoPreview" class="photoPreview" alt="Torque photo preview" />
        <div id="torquePhotoStatus" class="photoNote"></div>
        <div class="row-actions" style="margin-top:10px;justify-content:flex-start">
          <a class="btn secondary mini" id="openEquipmentPageBtn" href="index.html">Open Equipment Page</a>
        </div>
      </div>

      <div class="section" id="notesSec">
        <div class="section-title">Torque Notes & Units</div>
        <div class="grid2">
          <div>
            <label for="unitSelect">Units</label>
            <select id="unitSelect">
              <option value="ft-lbs">ft-lbs</option>
              <option value="in-lbs">in-lbs</option>
              <option value="Nm">Nm</option>
            </select>
          </div>
          <div>
            <label for="notesTorque">Torque Value</label>
            <input id="notesTorque" type="text" placeholder="Enter torque value" />
          </div>
        </div>
      </div>

      <div class="section" id="entriesSec">
        <div class="section-title">Torque Application Entries</div>
        <div class="row-actions" style="margin-bottom:10px">
          <button class="btn secondary mini" type="button" id="addRowBtn">Add Row</button>
          <button class="btn secondary mini" type="button" id="clearRowsBtn">Clear</button>
        </div>
        <table>
          <thead>
            <tr>
              <th style="width:14%">Date</th>
              <th style="width:14%">Time</th>
              <th style="width:18%">Location</th>
              <th style="width:18%">Bolt Size</th>
              <th style="width:12%">Unit</th>
              <th style="width:12%">Value</th>
              <th style="width:12%">Notes</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="section" id="tilt">
        <div class="section-title">Tilt Test (Go / No Go)</div>
        <div class="hint" style="padding:0;color:rgba(255,255,255,0.75);font-weight:800">
          Complete all cells to unlock torque entry above.
        </div>

        <table>
          <thead>
            <tr>
              <th style="width:32%">Pre Torque Tilt Test</th>
              <th style="width:22%">A-B</th>
              <th style="width:22%">A-C</th>
              <th style="width:22%">B-C</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="font-weight:900">Phase to Phase</td>
              <td data-tilt="AB"></td>
              <td data-tilt="AC"></td>
              <td data-tilt="BC"></td>
            </tr>
          </tbody>
        </table>

        <div style="height:10px"></div>

        <table>
          <thead>
            <tr>
              <th style="width:32%"></th>
              <th style="width:22%">A-G</th>
              <th style="width:22%">B-G</th>
              <th style="width:22%">C-G</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="font-weight:900">Phase to Ground</td>
              <td data-tilt="AG"></td>
              <td data-tilt="BG"></td>
              <td data-tilt="CG"></td>
            </tr>
          </tbody>
        </table>

        <div style="height:10px"></div>

        <table>
          <thead>
            <tr>
              <th style="width:32%"></th>
              <th style="width:22%">A-N</th>
              <th style="width:22%">B-N</th>
              <th style="width:22%">C-N</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="font-weight:900">Phase to Neutral</td>
              <td data-tilt="AN"></td>
              <td data-tilt="BN"></td>
              <td data-tilt="CN"></td>
            </tr>
          </tbody>
        </table>

        <div style="height:10px"></div>

        <table>
          <thead>
            <tr>
              <th style="width:32%"></th>
              <th style="width:68%">N-G</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="font-weight:900">Neutral to Ground</td>
              <td data-tilt="NG"></td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<script>
(function(){
  const qs=new URLSearchParams(location.search);
  const eq=(qs.get("eq")||"").trim();

  const eqLabel=document.getElementById("eqLabel");
  const subEq=document.getElementById("subEq");
  if(eqLabel) eqLabel.textContent=eq?`Equipment: ${eq}`:"Missing equipment ID (eq)";
  if(subEq) subEq.textContent=eq?`Equipment: ${eq}`:"Equipment: (none)";

  function setHrefWithEq(el, href){
    if(!el) return;
    try{
      const u = new URL(href, location.href);
      if(eq) u.searchParams.set("eq", eq);
      el.href = u.pathname + u.search + u.hash;
    }catch(e){
      el.href = href;
    }
  }
  setHrefWithEq(document.getElementById("backBtn"), "equipment.html");
  setHrefWithEq(document.getElementById("backBtn2"), "equipment.html");
  setHrefWithEq(document.getElementById("openEquipmentPageBtn"), "index.html");

  // ===== Torque Photo (READ from localStorage set on index.html) =====
  const torquePhotoPreview = document.getElementById("torquePhotoPreview");
  const torquePhotoStatus = document.getElementById("torquePhotoStatus");
  function torquePhotoKey(eq){ return `nexus_${eq || "NO_EQ"}_torque_photo`; }

  function setTPStatus(msg){ if(torquePhotoStatus) torquePhotoStatus.textContent = msg || ""; }

  function loadTorquePhoto(){
    if(!eq){
      torquePhotoPreview.style.display="none";
      setTPStatus("Missing equipment ID (eq).");
      return;
    }
    try{
      const tp = localStorage.getItem(torquePhotoKey(eq));
      if(tp && tp.startsWith("data:image/")){
        torquePhotoPreview.src = tp;
        torquePhotoPreview.style.display = "block";
        setTPStatus("Loaded torque photo for this equipment (this device).");
      }else{
        torquePhotoPreview.style.display = "none";
        torquePhotoPreview.removeAttribute("src");
        setTPStatus("No torque photo saved yet. Add one on the Open Equipment page.");
      }
    }catch(e){
      torquePhotoPreview.style.display="none";
      setTPStatus("Could not read torque photo.");
    }
  }

  // ===== Rows =====
  const rowsEl=document.getElementById("rows");
  const addRowBtn=document.getElementById("addRowBtn");
  const clearRowsBtn=document.getElementById("clearRowsBtn");
  const notesUnit=document.getElementById('unitSelect');
  const notesTorque=document.getElementById('notesTorque');

  function dataKey(){return `nexus_${eq||"NO_EQ"}_torque_log_v2`;}
  function tiltKey(){return `nexus_${eq||"NO_EQ"}_torque_tilt_v2`;}

  function mkRow(obj){
    const tr=document.createElement("tr");
    function mkInput(type,val){
      const td=document.createElement("td");
      const div=document.createElement("div");
      div.className="cell";
      const input=document.createElement("input");
      input.type=type; input.value=val||"";
      div.appendChild(input); td.appendChild(div);
      return {td,input};
    }
    function mkSelect(opts,val){
      const td=document.createElement("td");
      const div=document.createElement("div");
      div.className="cell";
      const sel=document.createElement("select");
      opts.forEach(o=>{ const op=document.createElement("option"); op.value=o; op.textContent=o; sel.appendChild(op); });
      sel.value=val||opts[0]||"";
      div.appendChild(sel); td.appendChild(div);
      return {td,sel};
    }
    const d=mkInput("date",obj.date||"");
    const t=mkInput("time",obj.time||"");
    const loc=mkInput("text",obj.location||(eq||""));
    const bolt=mkInput("text",obj.bolt||"");
    const unit=mkSelect(["ft-lbs","in-lbs","Nm"],obj.unit||"ft-lbs");
    const val=mkInput("text",obj.value||"");
    const notes=mkInput("text",obj.notes||"");
    tr.appendChild(d.td); tr.appendChild(t.td); tr.appendChild(loc.td); tr.appendChild(bolt.td);
    tr.appendChild(unit.td); tr.appendChild(val.td); tr.appendChild(notes.td);
    return tr;
  }

  function readRows(){
    const out=[];
    rowsEl.querySelectorAll("tr").forEach(tr=>{
      const cells=tr.querySelectorAll("input,select");
      if(cells.length<7) return;
      out.push({
        date:cells[0].value||"",
        time:cells[1].value||"",
        location:cells[2].value||"",
        bolt:cells[3].value||"",
        unit:cells[4].value||"",
        value:cells[5].value||"",
        notes:cells[6].value||"",
      });
    });
    return out;
  }
  function setRows(rows){
    rowsEl.innerHTML="";
    const list=Array.isArray(rows)?rows:[];
    if(list.length===0){ rowsEl.appendChild(mkRow({location:eq||""})); return; }
    list.forEach(r=>rowsEl.appendChild(mkRow(r)));
  }

  addRowBtn.addEventListener('click',()=>rowsEl.appendChild(mkRow({location:eq||""})));
  clearRowsBtn.addEventListener('click',()=>{ if(confirm('Clear all rows?')) setRows([]); });

  // ===== Tilt Matrix =====
  const TILT_KEYS=["AB","AC","BC","AG","BG","CG","AN","BN","CN","NG"];

  function mkGoNoGoCell(td, value){
    td.innerHTML = `
      <div class="go-wrap">
        <div class="pill go" data-v="GO">GO</div>
        <div class="pill nogo" data-v="NO_GO">NO GO</div>
      </div>
    `;
    const pills=[...td.querySelectorAll('.pill')];
    function apply(v){
      pills.forEach(p=>p.classList.toggle('on', p.getAttribute('data-v')===v));
      td.setAttribute('data-result', v||'');
      applyLock();
    }
    pills.forEach(p=>p.addEventListener('click',()=>apply(p.getAttribute('data-v'))));
    apply(value);
  }

  function setTilt(obj){
    document.querySelectorAll('[data-tilt]').forEach(td=>{
      const k = td.getAttribute('data-tilt');
      mkGoNoGoCell(td, (obj && obj[k]) ? obj[k] : '');
    });
  }

  function readTilt(){
    const out={};
    document.querySelectorAll('[data-tilt]').forEach(td=>{
      const k=td.getAttribute('data-tilt');
      out[k]=td.getAttribute('data-result')||'';
    });
    return out;
  }

  // ===== Lock notes+entries until tilt complete =====
  function findSectionByTitle(exact){
    const want=String(exact||"").trim().toLowerCase();
    const secs=[...document.querySelectorAll(".section")];
    for(const s of secs){
      const t=s.querySelector(".section-title");
      const txt=(t?t.textContent:"").trim().toLowerCase();
      if(txt===want) return s;
    }
    return null;
  }

  const notesSec=findSectionByTitle("Torque Notes & Units");
  const entriesSec=findSectionByTitle("Torque Application Entries");

  const wrap=document.createElement("div");
  wrap.className="nx-torque-lock-wrap";
  const parent=notesSec.parentNode;
  parent.insertBefore(wrap, notesSec);
  wrap.appendChild(notesSec);
  wrap.appendChild(entriesSec);

  const overlay=document.createElement("div");
  overlay.id="nxTorqueLockOverlay";
  overlay.innerHTML=`
    <div class="card2">
      <h3 style="margin:0 0 6px;font-weight:900;letter-spacing:.2px">Torque Locked</h3>
      <p style="margin:0 0 10px;color:rgba(255,255,255,0.9);font-weight:800">
        Complete the Tilt Test (Go / No Go) below to unlock torque entry.
      </p>
      <p style="margin:0;color:rgba(255,255,255,0.72);font-weight:800">
        All Tilt cells must be selected.
      </p>
    </div>
  `;
  wrap.appendChild(overlay);

  function allTiltComplete(){
    const t=readTilt();
    return TILT_KEYS.every(k => !!String((t||{})[k]||"").trim());
  }
  function applyLock(){
    const ok=allTiltComplete();
    wrap.classList.toggle("nx-locked", !ok);
    overlay.style.display = ok ? "none" : "flex";
  }

  // ===== Save/Load =====
  function saveLocal(){
    const payload={
      meta:{eq, updatedAt:new Date().toISOString()},
      notes:{unit:notesUnit.value, torque:notesTorque.value},
      rows:readRows(),
      tilt:readTilt(),
    };
    localStorage.setItem(dataKey(), JSON.stringify(payload));
    localStorage.setItem(tiltKey(), JSON.stringify(payload.tilt));
    applyLock();
  }

  function loadLocal(){
    try{
      const raw=localStorage.getItem(dataKey());
      if(raw){
        const p=JSON.parse(raw);
        notesUnit.value=p?.notes?.unit||"ft-lbs";
        notesTorque.value=p?.notes?.torque||"";
        setRows(p?.rows||[]);
        setTilt(p?.tilt||{});
        applyLock();
        return;
      }
    }catch(e){}
    setRows([]);
    setTilt({});
    applyLock();
  }

  document.getElementById("saveBtn").addEventListener("click",()=>{ saveLocal(); alert("Saved."); });
  document.getElementById("exportEmailBtn").addEventListener("click",()=>{
    saveLocal();
    const subject=`NEXUS Torque Log - ${eq||"NO_EQ"}`;
    const body=`Torque Log for ${eq||"NO_EQ"}%0D%0A%0D%0A(Export payload saved locally.)`;
    location.href=`mailto:?subject=${encodeURIComponent(subject)}&body=${body}`;
  });

  // Role display only
  const roleSel=document.getElementById("nxRoleSelect");
  const roleLabel=document.getElementById("roleLabel");
  function setRoleLabel(){
    const v=(roleSel&&roleSel.value)?roleSel.value:"viewer";
    if(roleLabel) roleLabel.textContent=v;
  }
  if(roleSel){
    roleSel.addEventListener("change",()=>{
      setRoleLabel();
      try{ localStorage.setItem("nexus_role", roleSel.value); }catch(e){}
    });
    try{
      const saved=localStorage.getItem("nexus_role");
      if(saved) roleSel.value=saved;
    }catch(e){}
  }
  setRoleLabel();

  // Init
  loadTorquePhoto();
  loadLocal();

  // When returning to tab, refresh photo
  window.addEventListener("focus", loadTorquePhoto);
})();
</script>

<script src="config.js"></script>
<script src="app.js"></script>
<script src="nexus-core.js"></script>
<script src="nexus-firebase-bridge.js"></script>
</body>
</html>
