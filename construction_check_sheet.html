<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Construction Check Sheet</title>

<link rel="stylesheet" href="assets/css/nexus-core.css">
<script defer src="assets/js/nexus-core.js"></script>
<script defer src="assets/js/nexus-firebase-bridge.js"></script>

<style>
  body{
    margin:0;
    font-family: system-ui,-apple-system,Segoe UI,Roboto;
    background:url("assets/img/bg.jpg") center/cover fixed;
  }
  .overlay{
    backdrop-filter: blur(10px);
    background: rgba(0,0,0,.45);
    min-height:100vh;
    padding:24px;
  }
  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:16px;
    gap:12px;
    flex-wrap:wrap;
  }
  .top-left{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }

  .btn{
    padding:8px 14px;
    border-radius:16px;
    border:none;
    font-weight:600;
    cursor:pointer;
    user-select:none;
  }
  .btn-glass{ background:rgba(255,255,255,.18); color:#fff; }
  .btn-blue{ background:#0ea5ff; color:#fff; }
  .btn-green{ background:#22c55e; color:#fff; }
  .btn-dark{ background:#111; color:#fff; }

  .card{
    background:rgba(255,255,255,.96);
    border-radius:16px;
    padding:24px;
    max-width:1500px;
    margin:auto;
  }

  h1{ font-size:28px; margin:0 0 6px; }
  .sub{ color:#333; margin:0 0 12px; font-weight:600; }

  .banner{
    display:none;
    margin:0 0 14px;
    padding:10px 12px;
    border-radius:12px;
    background:#111;
    color:#fff;
    font-weight:600;
  }
  .banner.bad{ background:#b91c1c; }
  .banner.good{ background:#166534; }

  .table-wrap{ overflow:auto; }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:16px;
  }
  th,td{
    border:1px solid #dcdcdc;
    padding:12px;
    vertical-align:top;
  }
  th{
    position:sticky;
    top:0;
    background:#111;
    color:#fff;
    font-size:15px;
    text-align:left;
    z-index:2;
  }

  td[contenteditable]{
    background:#fff;
    outline:none;
    min-width:120px;
    white-space:pre-wrap;
    overflow-wrap:anywhere;
  }
  td[contenteditable]:focus{ background:#fff8dc; }

  /* “Test/Procedure” column is bigger for mobile readability */
  td.col-proc{ min-width:360px; }

  .handoff-row td{
    background:#7ed957;
    font-weight:800;
  }

  .delete-btn{
    cursor:pointer;
    color:#b91c1c;
    font-weight:900;
    text-align:center;
    width:44px;
    user-select:none;
  }

  /* required/changed visuals */
  .missing{
    outline:3px solid #dc2626;
    outline-offset:-2px;
    background:#fff0f0 !important;
  }
  .changed{
    box-shadow: inset 0 0 0 2px rgba(14,165,255,.35);
    background:#f7fbff !important;
  }

  /* Mobile-friendly stacking */
  @media (max-width: 820px){
    .overlay{ padding:14px; }
    .card{ padding:16px; }
    table{ font-size:15px; }
    th,td{ padding:10px; }
    td.col-proc{ min-width:520px; } /* stays wide so horizontal scroll is usable */
  }

  @media print{
    body{ background:#fff; }
    .overlay{ background:#fff; backdrop-filter:none; }
    .topbar{ display:none; }
    .banner{ display:none !important; }
  }
</style>
</head>

<body>
<div class="overlay">

  <div class="topbar">
    <div class="top-left">
      <a id="backBtn" class="btn btn-glass" href="equipment.html">← Back to Equipment</a>
      <span id="equipmentLabel" style="color:white;font-weight:700"></span>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button id="saveBtn" class="btn btn-blue">Save</button>
      <button id="addRowBtn" class="btn btn-dark">+ Row</button>
      <button id="exportJsonBtn" class="btn btn-glass">Export JSON</button>
      <button id="exportCsvBtn" class="btn btn-glass">Export CSV</button>
      <button id="exportExcelBtn" class="btn btn-glass">Export Excel</button>
      <button id="printBtn" class="btn btn-green">Print / PDF</button>
    </div>
  </div>

  <div class="card">
    <h1>Construction Check Sheet</h1>
    <p class="sub">Construction Items</p>

    <div id="banner" class="banner"></div>

    <div class="table-wrap">
      <table id="sheet">
        <thead>
          <tr>
            <th style="width:70px">#</th>
            <th style="min-width:520px">Construction Items</th>
            <th style="width:280px">Notes</th>
            <th style="width:160px">Sign Off</th>
            <th style="width:170px">Date</th>
            <th style="width:54px"></th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* =========================
   Routing
========================= */
const params = new URLSearchParams(location.search);
const eq = params.get("eq") || "";
document.getElementById("equipmentLabel").textContent = eq ? ("Equipment: " + eq) : "";
document.getElementById("backBtn").href = "equipment.html" + (eq ? ("?eq=" + encodeURIComponent(eq)) : "");

/* =========================
   Sheet definition (restored content)
========================= */
const DEFAULT_ROWS = [
  { type:"title", item:"LV Transformer 001" },

  { type:"item", item:"Building Number", required:{ notes:true } },
  { type:"item", item:"Phase", required:{ notes:true } },
  { type:"item", item:"Foreman", required:{ notes:true } },
  { type:"item", item:"Equip ID", required:{ notes:true } },

  { type:"item", item:"Equipment Information", required:{ notes:true } },
  { type:"item", item:"RIF Completed" },
  { type:"item", item:"Labels installed by QCX" },
  { type:"item", item:"Phenolic" },
  { type:"item", item:"Arc Flash" },

  { type:"handoff", item:"QCX Sign Off (Handoff Gate)", required:{ sign:true, date:true } },

  { type:"item", item:"Equipment Mounted / Installation Specs" },
  { type:"item", item:"6\" clearance from walls and panels" },
  { type:"item", item:"Remove front cover bolts, bag & tag, leaving proper amount of bolts to hold cover in place" },
  { type:"item", item:"Shipping assembly (if required)" },
  { type:"item", item:"Apply proper cover for equipment protection" },
  { type:"item", item:"Anchored using 1/2\" concrete wedge anchors" },
  { type:"item", item:"Housing is mounted squared and leveled" },
  { type:"item", item:"XFMR Neta Tested (validated by QCx)" },

  { type:"handoff", item:"QCX Handoff to Construction (Sign + Date)", required:{ sign:true, date:true } },

  { type:"item", item:"Internal Wiring and Termination Specifications" },
  { type:"item", item:"1. Hardware Installation:" },
  { type:"item", item:"Install proper/correct phase lugs (with min 1\" gap from nearest item)" },
  { type:"item", item:"Install proper ground bar (if required)" },

  { type:"item", item:"2. Primary / High Side:" },
  { type:"item", item:"Primary wire matches 1 Line Diagram: (3) AL #1/0 and 1 CU #6 Ground (A100.3)" },
  { type:"item", item:"Verify primary wire phase color: H1/A-Brown H2/B-Orange H3/C-Yellow Ground-Green" },
  { type:"item", item:"Verify installation and termination of ground bonding bushing" },

  { type:"item", item:"3. Secondary / Low Side:" },
  { type:"item", item:"Secondary wire matches 1 Line Diagram: (3) AL #1/0 and Ground 1 CU #6 (A100.3) Neutral wire AL #1/0 (A110.T)" },
  { type:"item", item:"Verify secondary wire phase color: X1/A-Black X2/B-Red X3/C-Blue Ground-Green Neutral-White" },
  { type:"item", item:"Verify installation and termination of ground bonding bushing" },

  { type:"item", item:"4. Building Steel:" },
  { type:"item", item:"Verify that ground is #8 copper or larger" },

  { type:"item", item:"5. Bonding Jumper:" },
  { type:"item", item:"Bonding jumper must be AL #1/0 wire (or same size as biggest conductor on pri. or sec.) and all black" },

  { type:"item", item:"6. Verify hardware kit matches attached inventory sheet" },
  { type:"item", item:"7. Install front cover with all hardware" },

  { type:"handoff", item:"Foreman in charge verify all complete and handoff to QCX", required:{ sign:true, date:true } },

  { type:"item", item:"Construction Foreman Name", required:{ notes:true } },
  { type:"item", item:"QCX Foreman Name", required:{ notes:true } },
  { type:"item", item:"Date", required:{ notes:true } },
];

/* =========================
   DOM helpers
========================= */
const body = document.getElementById("body");
const banner = document.getElementById("banner");

function showBanner(msg, kind){
  banner.textContent = msg;
  banner.className = "banner " + (kind || "");
  banner.style.display = "block";
  clearTimeout(showBanner._t);
  showBanner._t = setTimeout(()=>{ banner.style.display="none"; }, 4500);
}

function makeCell(text="", className=""){
  const td = document.createElement("td");
  td.contentEditable = "true";
  td.spellcheck = false;
  if(className) td.className = className;
  td.textContent = text;
  td.dataset.orig = text; // for change highlighting
  return td;
}

function makeRow(model, index){
  const tr = document.createElement("tr");
  tr.dataset.type = model.type || "item";

  if(model.type === "handoff"){
    tr.classList.add("handoff-row");
  }

  // # cell (not editable)
  const tdNum = document.createElement("td");
  tdNum.textContent = String(index);
  tdNum.style.fontWeight = "800";
  tr.appendChild(tdNum);

  // item / procedure (editable, larger)
  const tdItem = makeCell(model.item || "", "col-proc");
  tr.appendChild(tdItem);

  // notes / entry (editable)
  const tdNotes = makeCell(model.notes || "");
  tr.appendChild(tdNotes);

  // sign off (editable)
  const tdSign = makeCell(model.sign || "");
  tr.appendChild(tdSign);

  // date (editable)
  const tdDate = makeCell(model.date || "");
  tr.appendChild(tdDate);

  // delete control
  const tdDel = document.createElement("td");
  tdDel.className = "delete-btn";
  tdDel.textContent = "✕";
  tdDel.title = "Delete row";
  tr.appendChild(tdDel);

  // required metadata
  tr.dataset.reqNotes = model.required?.notes ? "1" : "0";
  tr.dataset.reqSign = model.required?.sign ? "1" : "0";
  tr.dataset.reqDate = model.required?.date ? "1" : "0";

  return tr;
}

function renumber(){
  [...body.rows].forEach((r,i)=>{ r.cells[0].textContent = String(i+1); });
}

/* =========================
   Auto-grow (contenteditable)
========================= */
function autoGrowCell(td){
  // Let the browser wrap; this just ensures height expands naturally by using <br> for empty cells
  if(td.textContent === "") td.innerHTML = "<br>";
}

/* =========================
   Tab/Enter navigation (editable grid)
========================= */
function isEditableCell(cell){
  return cell && cell.getAttribute && cell.getAttribute("contenteditable") === "true";
}

function focusCell(r, c){
  const row = body.rows[r];
  if(!row) return;
  const cell = row.cells[c];
  if(!isEditableCell(cell)) return;
  cell.focus();
  const range = document.createRange();
  range.selectNodeContents(cell);
  range.collapse(false);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
}

/* =========================
   Change highlighting
========================= */
function updateChangedState(td){
  const orig = td.dataset.orig ?? "";
  const now = td.innerText.replace(/\u00A0/g," ").trim();
  const o = orig.replace(/\u00A0/g," ").trim();
  if(now !== o) td.classList.add("changed");
  else td.classList.remove("changed");
}

/* =========================
   Required-field validation
   Rules:
   - If row requires notes => Notes column must not be blank
   - If row requires sign/date => those columns must not be blank
========================= */
function clearValidation(){
  [...body.querySelectorAll(".missing")].forEach(el=>el.classList.remove("missing"));
}

function validateSheet(){
  clearValidation();
  let missingCount = 0;

  [...body.rows].forEach(row=>{
    const reqNotes = row.dataset.reqNotes === "1";
    const reqSign  = row.dataset.reqSign  === "1";
    const reqDate  = row.dataset.reqDate  === "1";

    const tdNotes = row.cells[2];
    const tdSign  = row.cells[3];
    const tdDate  = row.cells[4];

    if(reqNotes){
      if(!tdNotes.innerText.trim()){
        tdNotes.classList.add("missing");
        missingCount++;
      }
    }
    if(reqSign){
      if(!tdSign.innerText.trim()){
        tdSign.classList.add("missing");
        missingCount++;
      }
    }
    if(reqDate){
      if(!tdDate.innerText.trim()){
        tdDate.classList.add("missing");
        missingCount++;
      }
    }
  });

  if(missingCount){
    showBanner(`Missing required fields: ${missingCount}. Fill the red cells.`, "bad");
    return false;
  }
  showBanner("Validation OK.", "good");
  return true;
}

/* =========================
   Serialize / hydrate
========================= */
function serialize(){
  const out = {
    version: "1.0",
    equipment: eq || "",
    updatedAt: new Date().toISOString(),
    rows: []
  };

  [...body.rows].forEach(r=>{
    out.rows.push({
      type: r.dataset.type || "item",
      required: {
        notes: r.dataset.reqNotes === "1",
        sign:  r.dataset.reqSign === "1",
        date:  r.dataset.reqDate === "1"
      },
      item: r.cells[1].innerText.replace(/\u00A0/g," ").trim(),
      notes: r.cells[2].innerText.replace(/\u00A0/g," ").trim(),
      sign: r.cells[3].innerText.replace(/\u00A0/g," ").trim(),
      date: r.cells[4].innerText.replace(/\u00A0/g," ").trim(),
    });
  });

  return out;
}

function hydrate(doc){
  body.innerHTML = "";
  const rows = doc?.rows?.length ? doc.rows : DEFAULT_ROWS;
  rows.forEach((m, idx)=>{
    body.appendChild(makeRow(m, idx+1));
  });
  renumber();
}

/* =========================
   CSV + Excel export
========================= */
function csvEscape(v){
  const s = (v ?? "").toString().replace(/\u00A0/g," ");
  if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}

function exportCSV(){
  const doc = serialize();
  const header = ["#", "Construction Items", "Notes", "Sign Off", "Date"];
  const lines = [header.map(csvEscape).join(",")];

  doc.rows.forEach((r, i)=>{
    lines.push([
      String(i+1),
      r.item || "",
      r.notes || "",
      r.sign || "",
      r.date || ""
    ].map(csvEscape).join(","));
  });

  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `construction_check_sheet${eq ? "_" + eq : ""}.csv`;
  a.click();
}

function exportExcelHTML(){
  // Simple Excel-compatible HTML table export (.xls). Opens in Excel.
  const doc = serialize();
  const rowsHtml = doc.rows.map((r, i)=>(
    `<tr>
      <td>${i+1}</td>
      <td>${(r.item||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</td>
      <td>${(r.notes||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</td>
      <td>${(r.sign||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</td>
      <td>${(r.date||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</td>
    </tr>`
  )).join("");

  const html =
`<html>
<head><meta charset="UTF-8"></head>
<body>
  <table border="1">
    <tr><th>#</th><th>Construction Items</th><th>Notes</th><th>Sign Off</th><th>Date</th></tr>
    ${rowsHtml}
  </table>
</body>
</html>`;

  const blob = new Blob([html], {type:"application/vnd.ms-excel;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `construction_check_sheet${eq ? "_" + eq : ""}.xls`;
  a.click();
}

/* =========================
   Firebase save/load
   - Uses nexus-firebase-bridge.js if it exposes a global bridge.
   - Falls back to localStorage if Firebase bridge is not present.
   You may need to map these calls to your real bridge methods.
========================= */
const STORAGE_KEY = `nexus:construction_check_sheet:${eq || "noeq"}`;

function getFirebaseBridge(){
  // Common patterns: window.NEXUS_FIREBASE, window.nexusFirebaseBridge, window.FirebaseBridge
  return window.NEXUS_FIREBASE || window.nexusFirebaseBridge || window.FirebaseBridge || null;
}

async function saveDoc(doc){
  const bridge = getFirebaseBridge();
  // Always keep a local copy too
  localStorage.setItem(STORAGE_KEY, JSON.stringify(doc));

  if(!bridge){
    showBanner("Saved locally (Firebase bridge not found).", "good");
    return;
  }

  // Try a few likely method names
  const id = STORAGE_KEY;

  if(typeof bridge.save === "function"){
    await bridge.save(id, doc);
    showBanner("Saved to Firebase.", "good");
    return;
  }
  if(typeof bridge.setDoc === "function"){
    await bridge.setDoc(id, doc);
    showBanner("Saved to Firebase.", "good");
    return;
  }
  if(typeof bridge.write === "function"){
    await bridge.write(id, doc);
    showBanner("Saved to Firebase.", "good");
    return;
  }

  showBanner("Saved locally (Firebase bridge present but method not recognized).", "bad");
}

async function loadDoc(){
  const bridge = getFirebaseBridge();
  const id = STORAGE_KEY;

  // Prefer Firebase if available
  if(bridge){
    try{
      if(typeof bridge.load === "function"){
        const d = await bridge.load(id);
        if(d){ showBanner("Loaded from Firebase.", "good"); return d; }
      }
      if(typeof bridge.getDoc === "function"){
        const d = await bridge.getDoc(id);
        if(d){ showBanner("Loaded from Firebase.", "good"); return d; }
      }
      if(typeof bridge.read === "function"){
        const d = await bridge.read(id);
        if(d){ showBanner("Loaded from Firebase.", "good"); return d; }
      }
    }catch(e){
      // fall back to local
      console.warn("Firebase load failed; falling back to localStorage.", e);
    }
  }

  const local = localStorage.getItem(id);
  if(local){
    showBanner("Loaded locally.", "good");
    return JSON.parse(local);
  }
  return null;
}

/* =========================
   Build initial table
========================= */
(async function init(){
  const existing = await loadDoc();
  hydrate(existing || { rows: DEFAULT_ROWS });

  // set original snapshots for change highlighting
  [...body.querySelectorAll('td[contenteditable="true"]')].forEach(td=>{
    td.dataset.orig = td.innerText.replace(/\u00A0/g," ").trim();
  });
})();

/* =========================
   Events
========================= */
document.getElementById("printBtn").onclick = ()=> window.print();

document.getElementById("addRowBtn").onclick = ()=>{
  const model = { type:"item", item:"New Item" };
  body.appendChild(makeRow(model, body.rows.length + 1));
  renumber();
};

body.addEventListener("click", (e)=>{
  if(e.target.classList.contains("delete-btn")){
    e.target.closest("tr")?.remove();
    renumber();
  }
});

body.addEventListener("input", (e)=>{
  const td = e.target;
  if(td && td.matches('td[contenteditable="true"]')){
    autoGrowCell(td);
    updateChangedState(td);
  }
});

body.addEventListener("keydown", (e)=>{
  const td = e.target;
  if(!td || !td.matches('td[contenteditable="true"]')) return;

  const cell = td;
  const row = cell.parentElement;
  const rIndex = row.rowIndex - 1; // tbody row index
  const cIndex = cell.cellIndex;

  // Enter moves down (same column). Shift+Enter inserts newline.
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    focusCell(rIndex + 1, cIndex);
  }

  // Tab navigation: default browser behavior is okay, but we enforce within table for consistency.
  if(e.key === "Tab"){
    e.preventDefault();
    const dir = e.shiftKey ? -1 : 1;

    let rr = rIndex, cc = cIndex + dir;
    const maxC = row.cells.length - 2; // last cell is delete button (not editable)
    const minC = 1; // skip # column

    while(true){
      if(cc > maxC){ rr++; cc = minC; }
      if(cc < minC){ rr--; cc = maxC; }
      if(rr < 0) return;
      if(rr >= body.rows.length) return;

      const target = body.rows[rr].cells[cc];
      if(isEditableCell(target)){ focusCell(rr, cc); return; }
      cc += dir;
    }
  }
});

document.getElementById("exportJsonBtn").onclick = ()=>{
  if(!validateSheet()) return;
  const doc = serialize();
  const blob = new Blob([JSON.stringify(doc, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `construction_check_sheet${eq ? "_" + eq : ""}.json`;
  a.click();
};

document.getElementById("exportCsvBtn").onclick = ()=>{
  if(!validateSheet()) return;
  exportCSV();
};

document.getElementById("exportExcelBtn").onclick = ()=>{
  if(!validateSheet()) return;
  exportExcelHTML();
};

document.getElementById("saveBtn").onclick = async ()=>{
  if(!validateSheet()) return;
  const doc = serialize();
  try{
    await saveDoc(doc);
    // after successful save, reset "orig" snapshots so changed highlighting clears
    [...body.querySelectorAll('td[contenteditable="true"]')].forEach(td=>{
      td.dataset.orig = td.innerText.replace(/\u00A0/g," ").trim();
      td.classList.remove("changed");
    });
  }catch(err){
    console.error(err);
    showBanner("Save failed. Check console.", "bad");
  }
};
</script>
</body>
</html>
